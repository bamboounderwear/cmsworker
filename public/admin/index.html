<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€¢ lightweight-cms</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
  <div class="container" x-data="cmsAdminHome()" x-init="init()">
    <div class="card">
      <div class="nav">
        <div class="brand">
          <span class="dot"></span>
          <div>
            <div style="font-weight:700;">Admin</div>
            <div class="small">Pages list (editor opens in a separate page)</div>
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center;">
          <a href="/">View site</a>
          <button style="width:auto;" @click="logout()">Log out</button>
        </div>
      </div>

      <template x-if="!isAuthed">
        <div class="notice">
          <div style="font-weight:700; margin-bottom:6px;">Login required</div>
          <div class="small">Uses Basic Auth. Default: admin / admin123</div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label class="small">Username</label>
              <input x-model="login.username" placeholder="admin" />
            </div>
            <div>
              <label class="small">Password</label>
              <input type="password" x-model="login.password" placeholder="admin123" />
            </div>
          </div>

          <div style="margin-top: 12px;">
            <button @click="doLogin()">Login</button>
          </div>

          <template x-if="error">
            <div style="margin-top:12px; color:#ffb2b2;" x-text="error"></div>
          </template>
        </div>
      </template>

      <template x-if="isAuthed">
        <div>
          <div style="display:flex; justify-content: space-between; align-items:center; gap:12px;">
            <div>
              <div style="font-weight:700;">Pages</div>
              <div class="small">Open editor to create or modify pages</div>
            </div>
            <button style="width:auto;" @click="openNew()">+ New</button>
          </div>

          <div class="hr"></div>

          <template x-if="pages.length === 0">
            <div class="small">No pages yet.</div>
          </template>

          <template x-if="pages.length > 0">
            <table class="table">
              <thead>
                <tr>
                  <th>Slug</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Updated</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <template x-for="p in pages" :key="p.slug">
                  <tr>
                    <td><a :href="'/' + p.slug" target="_blank" x-text="'/' + p.slug"></a></td>
                    <td x-text="p.type"></td>
                    <td x-text="p.status"></td>
                    <td x-text="formatTs(p.updated_at)"></td>
                    <td>
                      <div class="actions">
                        <button @click="openEdit(p.slug)">Open editor</button>
                        <button @click="delPage(p.slug)" style="background: rgba(255,120,120,0.10); border-color: rgba(255,120,120,0.35);">Delete</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </template>

          <template x-if="error">
            <div style="margin-top:12px; color:#ffb2b2;" x-text="error"></div>
          </template>
        </div>
      </template>
    </div>
  </div>

<script>
function cmsAdminHome() {
  return {
    pages: [],
    isAuthed: false,
    authHeader: "",
    login: { username: "admin", password: "admin123" },
    error: "",

    async init() {
      const saved = localStorage.getItem("cms_auth_header");
      if (saved) {
        this.authHeader = saved;
        this.isAuthed = true;
        await this.refreshPages();
      }
    },

    buildBasicHeader(username, password) {
      return "Basic " + btoa(username + ":" + password);
    },

    async doLogin() {
      this.error = "";
      this.authHeader = this.buildBasicHeader(this.login.username, this.login.password);

      // Probe auth by listing pages
      const ok = await this.refreshPages(true);
      if (!ok) {
        this.isAuthed = false;
        this.authHeader = "";
        return;
      }

      localStorage.setItem("cms_auth_header", this.authHeader);
      this.isAuthed = true;
    },

    logout() {
      localStorage.removeItem("cms_auth_header");
      this.isAuthed = false;
      this.authHeader = "";
      this.pages = [];
      this.error = "";
    },

    async api(url, opts = {}) {
      const headers = Object.assign({}, opts.headers || {}, {
        "Authorization": this.authHeader
      });
      return fetch(url, Object.assign({}, opts, { headers }));
    },

    async refreshPages(isProbe = false) {
      try {
        const res = await this.api("/api/pages");
        if (!res.ok) {
          if (isProbe) this.error = "Unauthorized. Check username/password.";
          return false;
        }
        const data = await res.json();
        this.pages = data.pages || [];
        this.error = "";
        return true;
      } catch (e) {
        this.error = "Failed to load pages.";
        return false;
      }
    },

    openEdit(slug) {
      window.location.href = "/admin/editor.html?slug=" + encodeURIComponent(slug);
    },

    openNew() {
      // Default to landing; editor lets you change type
      window.location.href = "/admin/editor.html?new=1&type=landing";
    },

    async delPage(slug) {
      if (!confirm("Delete /" + slug + "?")) return;
      this.error = "";
      const res = await this.api("/api/pages/" + encodeURIComponent(slug), { method: "DELETE" });
      if (!res.ok) {
        this.error = "Delete failed.";
        return;
      }
      await this.refreshPages();
    },

    formatTs(ts) {
      if (!ts) return "";
      try {
        const d = new Date(ts * 1000);
        return d.toLocaleString();
      } catch {
        return String(ts);
      }
    }
  }
}
</script>
</body>
</html>
